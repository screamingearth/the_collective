name: Validate the_collective

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    runs-on: ubuntu-latest
    name: Code Quality & Tests
    permissions:
      contents: read

    steps:
      - name: Checkout Code
        # Using inline git commands instead of actions/checkout to avoid external dependencies
        run: |
          cd $GITHUB_WORKSPACE
          git init
          git remote add origin https://github.com/${{ github.repository }}.git
          git fetch origin ${{ github.ref }} --depth=1
          git checkout FETCH_HEAD

      - name: Verify Node.js
        run: |
          which node
          which npm
          node --version
          npm --version

      - name: Security Audit
        run: |
          npm audit --audit-level=high
          cd .collective/memory-server && npm audit --audit-level=high
          cd ../gemini-bridge && npm audit --audit-level=high

      - name: Install Root Dependencies
        run: npm ci

      - name: Build Memory Server
        working-directory: .collective/memory-server
        run: |
          npm ci
          npm run build

      - name: Build Gemini Bridge
        working-directory: .collective/gemini-bridge
        run: |
          npm ci
          npm run build

      - name: Run Memory Server Tests
        working-directory: .collective/memory-server
        run: npm test

      - name: Run Gemini Bridge Tests
        working-directory: .collective/gemini-bridge
        run: npm test

      - name: Validate Code Quality
        run: npm run validate
