# >the_collective - Docker Compose Configuration
# Purpose: Orchestrate Memory Server and Gemini Bridge as containerized MCP servers
# Usage: docker compose up -d (starts in background)
#
# WINDOWS USERS (PowerShell):
#   If you get errors about ${HOME}, either:
#   1. Use Git Bash instead of PowerShell
#   2. Copy .env.example to .env and set HOME=C:/Users/YOUR_USERNAME

services:
  memory-server:
    build:
      context: .collective/memory-server
      dockerfile: Dockerfile
    container_name: collective-memory
    ports:
      - "3100:3100"
    volumes:
      # Mount database directory for persistence
      - ./.mcp:/data
    environment:
      - NODE_ENV=production
      - MEMORY_DB_PATH=/data/collective_memory.duckdb
      - MCP_TRANSPORT=sse
      - MCP_PORT=3100
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "node", "-e", "require('http').get('http://localhost:3100/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))" ]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    networks:
      - collective

  gemini-bridge:
    build:
      context: .collective/gemini-bridge
      dockerfile: Dockerfile
    container_name: collective-gemini
    ports:
      - "3101:3101"
    volumes:
      # Mount gemini CLI OAuth directory (google_accounts.json, etc.)
      # For OAuth: Run 'npm run auth' in .collective/gemini-bridge before 'docker compose up'
      # For API key: Set GEMINI_API_KEY env var (faster, recommended)
      #
      # Cross-platform path handling:
      # - Linux/macOS: Uses $HOME
      # - Windows: Falls back to $USERPROFILE (PowerShell/CMD)
      # - Git Bash: Works with either (sets $HOME automatically)
      # Note: rw required for gemini-cli 0.21+ (writes chat history to tmp/)
      - ${HOME:-${USERPROFILE}}/.gemini:/root/.gemini:rw
      # Mount project root for autonomous exploration (read-only for security)
      - .:/workspace:ro
    env_file:
      - path: .collective/gemini-bridge/.env
        required: false
    environment:
      - NODE_ENV=production
      - MCP_TRANSPORT=sse
      - MCP_PORT=3101
      - WORKSPACE_ROOT=/workspace
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "node", "-e", "require('http').get('http://localhost:3101/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))" ]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    networks:
      - collective

networks:
  collective:
    driver: bridge
